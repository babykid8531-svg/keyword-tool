import streamlit as st
from pytrends.request import TrendReq
import pandas as pd
import time

# --------------------
# ê¸°ë³¸ ì„¤ì •
# --------------------
st.set_page_config(page_title="í‚¤ì›Œë“œ ì¶”ì²œ ë° ë¶„ì„ë°›ê¸°", layout="wide")
st.title("í‚¤ì›Œë“œ ì¶”ì²œ ë° ë¶„ì„ë°›ê¸°")

keyword = st.text_input(
    "ë¶„ì„í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ˜Š",
    placeholder="ì˜ˆ: ì „ì£¼ ë•ì§„ê³µì›"
)

# --------------------
# í‚¤ì›Œë“œ ë¶„ì„ í•¨ìˆ˜
# --------------------
@st.cache_data(show_spinner=False)
def analyze(keyword):
    pytrends = TrendReq(hl='ko', tz=540)
    pytrends.build_payload([keyword], timeframe='today 12-m', geo='KR')

    related = pytrends.related_queries()

    if keyword not in related or related[keyword] is None:
        return [], pd.DataFrame()

    rq = related[keyword]
    frames = []

    if rq.get("top") is not None:
        frames.append(rq["top"])
    if rq.get("rising") is not None:
        frames.append(rq["rising"])

    if not frames:
        return [], pd.DataFrame()

    df = pd.concat(frames, ignore_index=True)
    df = df.drop_duplicates(subset="query").head(50)

    all_keywords = df["query"].tolist()

    top10_df = pd.DataFrame({
        "í‚¤ì›Œë“œ": all_keywords[:10],
        "ê²€ìƒ‰ëŸ‰": ["ë†’ìŒ", "ë†’ìŒ", "ì¤‘ìƒ", "ì¤‘ìƒ", "ì¤‘",
                 "ì¤‘", "ì¤‘", "ì¤‘", "ì¤‘", "ì¤‘"],
        "ì´ìœ ": [
            "ì—¬í–‰ ëŒ€í‘œ í‚¤ì›Œë“œ",
            "ì—¬í–‰ ëŒ€í‘œ í‚¤ì›Œë“œ",
            "ì§€ì—­ + ì£¼ì œ ê²°í•© í‚¤ì›Œë“œ",
            "ì§€ì—­ + ì£¼ì œ ê²°í•© í‚¤ì›Œë“œ",
            "ë™ì„ Â·ì½”ìŠ¤ íƒìƒ‰ ê²€ìƒ‰",
            "ë™ì„ Â·ì½”ìŠ¤ íƒìƒ‰ ê²€ìƒ‰",
            "ì§€ì—­ + ì£¼ì œ ê²°í•© í‚¤ì›Œë“œ",
            "í›„ê¸°í˜• ì½˜í…ì¸  ì„ í˜¸",
            "ì‚¬ì§„Â·ë·° ëª©ì  ê²€ìƒ‰",
            "ë™ì„ Â·ì½”ìŠ¤ íƒìƒ‰ ê²€ìƒ‰"
        ]
    })

    return all_keywords, top10_df


# --------------------
# ì‹¤í–‰ ë²„íŠ¼
# --------------------
if st.button("í‚¤ì›Œë“œ ì¶”ì²œ ë° ë¶„ì„í•˜ê¸°"):
    if not keyword:
        st.warning("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        st.stop()

    with st.spinner("Google Trends ê¸°ë°˜ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
        time.sleep(1)
        all_kw, top10_df = analyze(keyword)

    if not all_kw:
        st.info("ì—°ê´€ í‚¤ì›Œë“œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ë” ì¼ë°˜ì ì¸ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.")
        st.stop()

    # --------------------
    # 1ï¸âƒ£ ì—°ê´€ í‚¤ì›Œë“œ 50ê°œ
    # --------------------
    st.markdown("## 1ï¸âƒ£ ì—°ê´€ í‚¤ì›Œë“œ 50ê°œ")
    grid = [all_kw[i:i+5] for i in range(0, len(all_kw), 5)]
    st.dataframe(pd.DataFrame(grid).fillna(""))

    # --------------------
    # 2ï¸âƒ£ ìƒìœ„ ë…¸ì¶œ ê°€ëŠ¥ í‚¤ì›Œë“œ + ì„ íƒ
    # --------------------
    st.markdown("## 2ï¸âƒ£ ìƒìœ„ ë…¸ì¶œ ê°€ëŠ¥ì„± ë†’ì€ í‚¤ì›Œë“œ 10ê°œ")
    st.caption("ì—¬ê¸°ì„œ **ìµœëŒ€ 3ê°œ** ì„ íƒí•˜ì„¸ìš”")

    selected_keywords = []

    for i, row in top10_df.iterrows():
        c1, c2, c3 = st.columns([4, 1.5, 4])

        with c1:
            checked = st.checkbox(row["í‚¤ì›Œë“œ"], key=f"kw_{i}")
            if checked:
                selected_keywords.append(row["í‚¤ì›Œë“œ"])

        with c2:
            st.write(row["ê²€ìƒ‰ëŸ‰"])

        with c3:
            st.write(row["ì´ìœ "])

    # --------------------
    # ê¸€ ë¼ˆëŒ€ ìƒì„±
    # --------------------
    st.markdown("---")

    if st.button("âœ… ì„ íƒí•œ í‚¤ì›Œë“œë¡œ ê¸€ ë¼ˆëŒ€ ë§Œë“¤ê¸°"):
        if len(selected_keywords) != 3:
            st.error("í‚¤ì›Œë“œë¥¼ ì •í™•íˆ 3ê°œ ì„ íƒí•´ì£¼ì„¸ìš”.")
            st.stop()

        main_kw = selected_keywords[0]
        sub1, sub2 = selected_keywords[1:]

        article = f"""
0ï¸âƒ£ ì´ ì§€ì¹¨ì„œ í•œ ë¬¸ì¥ ìš”ì•½  
ë„¤ì´ë²„ëŠ” â€˜ì •ë³´ êµ¬ì¡°ê°€ í”ë“¤ë¦¬ì§€ ì•ŠëŠ” ê¸€â€™ì„ ìœ„ë¡œ ì˜¬ë¦°ë‹¤.

---

## ì œëª©  
{main_kw} ìš´ì˜ì‹œê°„Â·ì£¼ì°¨Â·ìœ„ì¹˜ ì´ì •ë¦¬ ({sub1}, {sub2})

---

## ë„ì…ë¶€  
{main_kw}ì— ëŒ€í•´ ë°©ë¬¸ ì „ì— ê¼­ ì•Œì•„ì•¼ í•  ì •ë³´ë¥¼ ì •ë¦¬í–ˆë‹¤.  
ì´ ê¸€ì€ ìš´ì˜ ì •ë³´, ë™ì„ , ì ‘ê·¼ì„±ì„ ì¤‘ì‹¬ìœ¼ë¡œ êµ¬ì„±ëœë‹¤.  
ì²˜ìŒ ë°©ë¬¸í•˜ëŠ” ì‚¬ëŒë„ íë¦„ì„ í•œ ë²ˆì— ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì •ë¦¬í–ˆë‹¤.

---

## ì´ê³³ì€ ì–´ë–¤ ê³³ì¸ê°€  
{main_kw}ì€ ì§€ì—­ ëŒ€í‘œ ê³µê°„ìœ¼ë¡œ í™œìš©ëœë‹¤.  
ê³¼ê±° ìš©ë„ì™€ í˜„ì¬ ì—­í• ì„ ê¸°ì¤€ìœ¼ë¡œ ì •ë¦¬í•œë‹¤.

---

## ìš´ì˜ì‹œê°„Â·ì´ìš© ì¡°ê±´  
ìš´ì˜ ìš”ì¼ê³¼ ì‹œê°„ì€ ê³µì‹ ê¸°ì¤€ì— ë”°ë¥¸ë‹¤.  
ì…ì¥ ë§ˆê° ë° ì£¼ì˜ì‚¬í•­ì„ í•¨ê»˜ í™•ì¸í•œë‹¤.

---

## ë‚´ë¶€ êµ¬ì¡°Â·ê´€ëŒ ë™ì„   
ì…êµ¬ â†’ ì£¼ìš” êµ¬ê°„ â†’ ì¢…ë£Œ ì§€ì  ìˆœìœ¼ë¡œ ì´ë™í•œë‹¤.  
ì „ì²´ ì†Œìš” ì‹œê°„ì€ í‰ê·  ê¸°ì¤€ìœ¼ë¡œ ì•ˆë‚´í•œë‹¤.

---

## ì£¼ì°¨Â·ëŒ€ì¤‘êµí†µ ì •ë³´  
ì£¼ì°¨ ê°€ëŠ¥ ì—¬ë¶€ì™€ ì£¼ì†Œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë¦¬í•œë‹¤.  
ëŒ€ì¤‘êµí†µ ì ‘ê·¼ì„±ë„ í•¨ê»˜ íŒë‹¨í•œë‹¤.

---

## ì´ëŸ° ì‚¬ëŒì—ê²Œ ë§ëŠ”ë‹¤  
- {sub1} ì •ë³´ë¥¼ ì°¾ëŠ” ì‚¬ëŒ  
- {sub2} ëª©ì  ë°©ë¬¸ì  
- ì¼ì •ì´ ì§§ì€ ë°©ë¬¸ì

---

## ë§ˆë¬´ë¦¬  
{main_kw}ì€ ì •ë³´ ì •ë¦¬ í›„ ë°©ë¬¸í•˜ë©´ íš¨ìœ¨ì´ ë†’ë‹¤.  
ë™ì„ ê³¼ ìš´ì˜ ì •ë³´ë¥¼ ë¯¸ë¦¬ í™•ì¸í•˜ëŠ” ê²ƒì´ í•µì‹¬ì´ë‹¤.  
ë°©ë¬¸ ì „ ì´ ê¸€ì„ ì°¸ê³ í•˜ë©´ ë„ì›€ì´ ë ê¹Œ?

---

## í•´ì‹œíƒœê·¸  
#{main_kw} #{sub1} #{sub2}
"""

        st.markdown("## âœï¸ ìƒì„±ëœ ê¸€ ë¼ˆëŒ€")
        st.markdown(article)
