import streamlit as st
import pandas as pd
import json
import time
import openai
from openai import OpenAI

# -----------------------------
# ê¸°ë³¸ ì„¤ì •
# -----------------------------
st.set_page_config(
    page_title="í‚¤ì›Œë“œ ì¶”ì²œ ë° ë¶„ì„ë°›ê¸°",
    layout="wide"
)

st.title("í‚¤ì›Œë“œ ì¶”ì²œ ë° ë¶„ì„ë°›ê¸°")
st.caption("ë„¤ì´ë²„ SEO ì‹¤ì „ìš© Â· í‚¤ì›Œë“œ ë¶„ì„ â†’ ê¸€ ìë™ ìƒì„±")

client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])

# -----------------------------
# ë„¤ì´ë²„ ê¸€ ì‘ì„± ì§€ì¹¨ì„œ (í”„ë¡¬í”„íŠ¸ìš©)
# -----------------------------
GUIDELINE = """
ë„ˆëŠ” ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì „ë¬¸ ì‘ê°€ì´ì SEO ì»¨ì„¤í„´íŠ¸ë‹¤.

[ëŒ€ì›ì¹™]
- êµ¬ì¡°ëŠ” í•­ìƒ ê°™ë‹¤.
- ì •ë³´ê°€ ê°ì •ë³´ë‹¤ ë¨¼ì €ë‹¤.
- ë…ìëŠ” ì²˜ìŒ ë°©ë¬¸í•˜ëŠ” ì‚¬ëŒì´ë‹¤.

[ê¸€ ì „ì²´ ê³ ì • êµ¬ì¡°]

ì œëª©
ë„ì…ë¶€(ì¸ì‚¬ + ìš”ì•½)

â‘  ì´ ê³µê°„/ì¥ì†Œ/ì„œë¹„ìŠ¤ëŠ” ë¬´ì—‡ì¸ê°€ìš”
â‘¡ ì–¸ì œÂ·ì–´ë–»ê²Œ ì´ìš©í•˜ë‚˜ìš” (ì‹œê°„Â·ìš”ì¼Â·ì¡°ê±´)
â‘¢ ë‚´ë¶€ êµ¬ì„±Â·ì´ìš© íë¦„Â·ë™ì„ ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”
â‘£ ì ‘ê·¼ ë°©ë²•Â·ì£¼ì°¨Â·êµí†µì€ ì–´ë–¤ê°€ìš”
â‘¤ ì´ëŸ° ì‚¬ëŒì—ê²Œ ì˜ ë§ì•„ìš”

ë§ˆë¬´ë¦¬
í•´ì‹œíƒœê·¸

[ì œëª© ì§€ì¹¨]
- í˜•ì‹: ì§€ì—­/ëŒ€ìƒ + ì´ë¦„ + í•µì‹¬ ì •ë³´ 2~3ê°œ + ì´ì •ë¦¬
- í•µì‹¬ ì •ë³´ ì˜ˆì‹œ: ìš´ì˜ì‹œê°„, ì£¼ì°¨, ìœ„ì¹˜, ì´ìš©ë°©ë²•, ìš”ê¸ˆ, ì˜ˆì•½
- ê°ì„± ë‹¨ì–´, í›„ê¸°í˜• í‘œí˜„, ì¶”ìƒì ì¸ í‘œí˜„ì€ ì œëª©ì— ì“°ì§€ ì•ŠëŠ”ë‹¤.

[ë„ì…ë¶€ ì§€ì¹¨]
- ë¶„ëŸ‰: 4~5ì¤„
- êµ¬ì„± ì˜ˆì‹œ:
  ì•ˆë…•í•˜ì„¸ìš”! ë¡œ ì‹œì‘
  ì˜¤ëŠ˜ì€ [ì§€ì—­]ì—ì„œ í•œ ë²ˆì¯¤ ê¶ê¸ˆí•´ì§ˆ ë§Œí•œ [ëŒ€ìƒ ì´ë¦„]ì„ ì •ë¦¬í–ˆë‹¤ê³  ë°íŒë‹¤.
  ì´ ëŒ€ìƒì˜ ì •ì²´ì„±ì„ í•œ ì¤„ë¡œ ì„¤ëª…í•œë‹¤.
  ìš´ì˜ì‹œê°„, ì´ìš© ë°©ë²•, ì£¼ì°¨ì™€ ë™ì„ ê¹Œì§€ í•œ ë²ˆì— í™•ì¸í•  ìˆ˜ ìˆê²Œ ì •ë¦¬í–ˆë‹¤ê³  ì•ˆë‚´í•œë‹¤.
  ì²˜ìŒ ë°©ë¬¸í•˜ëŠ” ì‚¬ëŒì—ê²Œ ë„ì›€ì´ ëœë‹¤ê³  ë§ˆë¬´ë¦¬í•œë‹¤.
- ë„ì…ë¶€ì—ëŠ” ê°ì •ì´ë‚˜ í›„ê¸° í‘œí˜„ì„ ë„£ì§€ ì•ŠëŠ”ë‹¤.

[â‘  ì´ê³³ì€ ë¬´ì—‡ì¸ê°€ìš”]
- ì •ì²´ì„±ì„ ì„¤ëª…í•˜ê³  ì‹ ë¢°ë¥¼ í™•ë³´í•˜ëŠ” íŒŒíŠ¸.
- ì„¤ëª… â†’ ë°°ê²½ â†’ í˜„ì¬ ëª¨ìŠµ ìˆœì„œ.
- ì—°ë„, ìˆ«ì, ì‚¬ì‹¤ ì •ë³´ë¥¼ ìš°ì„ .
- í•œ ë¬¸ë‹¨ì— ê°ì • í‘œí˜„ì€ í•œ ë¬¸ì¥ë§Œ í—ˆìš©.
- ê°ìƒë¬¸ì´ ì•„ë‹ˆë¼ ì„¤ëª…ë¬¸Â·ê´€ì°° ìœ„ì£¼ë¡œ ì‘ì„±.

[â‘¡ ì´ìš© ì‹œê°„Â·ì¡°ê±´]
- ìš”ì¼, ìš´ì˜ì‹œê°„, ì…ì¥ ë§ˆê° ì‹œê°„, íœ´ë¬´ì¼, ì˜ˆì™¸ì‚¬í•­ì„ ëª…í™•í•˜ê²Œ ì •ë¦¬.
- ë‹¨ì •ì ì¸ ë¬¸ì¥, ì• ë§¤í•œ í‘œí˜„ ì‚¬ìš© ê¸ˆì§€.
- ë§ˆì§€ë§‰ì— ì£¼ì˜ì‚¬í•­ ë˜ëŠ” íŒ í•œ ì¤„.

[â‘¢ ë‚´ë¶€ êµ¬ì„±Â·ë™ì„ Â·ì´ìš© íë¦„]
- ì²˜ìŒ ê°€ëŠ” ì‚¬ëŒ ê¸°ì¤€ìœ¼ë¡œ ì•ˆë‚´.
- ì–´ë””ì„œë¶€í„° ì‹œì‘í•˜ë©´ ì¢‹ì€ì§€, ì–´ë–¤ ìˆœì„œë¡œ ë³´ë©´ ì¢‹ì€ì§€, ì „ì²´ ì†Œìš” ì‹œê°„ì„ ì„¤ëª….
- ì‚¬ì§„ í¬ì¸íŠ¸Â·ê´€ëŒ í¬ì¸íŠ¸ ìœ„ì¹˜ë„ í•¨ê»˜ ì–¸ê¸‰.
- ë§ˆì§€ë§‰ì— ì‹¤ì „ íŒ í•œ ì¤„.

[â‘£ ì£¼ì°¨Â·êµí†µÂ·ì ‘ê·¼ì„±]
- ê°ì • ì—†ì´ ì •ë³´ë§Œ ì „ë‹¬.
- ì£¼ì°¨: ë¬´ë£Œ/ìœ ë£Œ, ì£¼ì°¨ ê°€ëŠ¥ ëŒ€ìˆ˜, ë„ë³´ ê±°ë¦¬.
- ëŒ€ì¤‘êµí†µ: ì£¼ìš” ì¶œë°œì§€ ê¸°ì¤€ ë…¸ì„ , í•˜ì°¨ í›„ ë„ë³´ ì‹œê°„.
- ë§ˆì§€ë§‰ì— ì ‘ê·¼ì„± ì¢…í•© íŒë‹¨ í•œ ì¤„(ì˜ˆ: ìì°¨ ë°©ë¬¸ì´ í¸í•œ í¸ì´ë‹¤ ë“±).

[â‘¤ ì´ëŸ° ì‚¬ëŒì—ê²Œ ë§ì•„ìš”]
- â€œë¬´ì¡°ê±´ ì¶”ì²œâ€ì´ ì•„ë‹ˆë¼ ì–´ë–¤ ìœ í˜•ì—ê²Œ ì í•©í•œì§€ ì •ë¦¬.
- ì˜ˆ: ì¡°ìš©íˆ ë‘˜ëŸ¬ë³´ê³  ì‹¶ì€ ì‚¬ëŒ, ì•„ì´ì™€ í•¨ê»˜ ì˜¤ëŠ” ê°€ì¡±, ì‚¬ì§„ ìœ„ì£¼ ì—¬í–‰ëŸ¬ ë“±.
- â€œê°•ë ¥ ì¶”ì²œ, ë¬´ì¡°ê±´ ê°€ì•¼ í•œë‹¤â€ ê°™ì€ í‘œí˜„ì€ ì“°ì§€ ì•ŠëŠ”ë‹¤.

[ë§ˆë¬´ë¦¬ ë¬¸ë‹¨]
- 3ë¬¸ì¥ êµ¬ì¡°:
  â‘  ì „ì²´ ìš”ì•½
  â‘¡ í•µì‹¬ ì¥ì  ì •ë¦¬
  â‘¢ ë¶€ë“œëŸ¬ìš´ ë°©ë¬¸ ìœ ë„ (ì§ˆë¬¸í˜• 1ë¬¸ì¥ê¹Œì§€ í—ˆìš©)

[í•´ì‹œíƒœê·¸]
- 7~10ê°œ.
- êµ¬ì„±: ê³ ìœ ëª…ì‚¬ 2ê°œ / ì§€ì—­ ê´€ë ¨ 2ê°œ / ì¹´í…Œê³ ë¦¬ 2ê°œ / ì •ë³´í˜• í‚¤ì›Œë“œ 2ê°œ.
- ê°ì„± íƒœê·¸, ì˜ë¯¸ ì—†ëŠ” íƒœê·¸ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
"""

# -----------------------------
# GPT í˜¸ì¶œ ìœ í‹¸ (RateLimit ë°©ì–´ìš©)
# -----------------------------
def call_gpt_json(system_msg: str, user_msg: str, max_retries: int = 3):
    last_err = None
    for i in range(max_retries):
        try:
            res = client.chat.completions.create(
                model="gpt-4.1-mini",
                messages=[
                    {"role": "system", "content": system_msg},
                    {"role": "user", "content": user_msg},
                ],
                temperature=0.4,
            )
            content = res.choices[0].message.content.strip()
            return json.loads(content)
        except openai.RateLimitError as e:
            last_err = e
            time.sleep(1.5 * (i + 1))
        except json.JSONDecodeError as e:
            last_err = e
            break
    raise last_err


def call_gpt_text(system_msg: str, user_msg: str, max_retries: int = 3) -> str:
    last_err = None
    for i in range(max_retries):
        try:
            res = client.chat.completions.create(
                model="gpt-4.1-mini",
                messages=[
                    {"role": "system", "content": system_msg},
                    {"role": "user", "content": user_msg},
                ],
                temperature=0.5,
            )
            return res.choices[0].message.content.strip()
        except openai.RateLimitError as e:
            last_err = e
            time.sleep(1.5 * (i + 1))
    raise last_err

# -----------------------------
# 1ë‹¨ê³„: í‚¤ì›Œë“œ ë¶„ì„ (ì—°ê´€ 50ê°œ + ìƒìœ„ 10ê°œ)
# -----------------------------
def analyze_keywords(base_keyword: str):
    """
    base_keyword í•˜ë‚˜ë¥¼ ë°›ì•„ì„œ
    - ì—°ê´€ í‚¤ì›Œë“œ 50ê°œ (ê²©ì)
    - ìƒìœ„ ë…¸ì¶œ ê°€ëŠ¥ í‚¤ì›Œë“œ 10ê°œ (í‚¤ì›Œë“œ/ê²€ìƒ‰ëŸ‰/ì´ìœ )
    ë¥¼ ë°˜í™˜.
    """

    user_prompt = f"""
ë„ˆëŠ” í•œêµ­ ë„¤ì´ë²„ ë¸”ë¡œê·¸ìš© SEO í‚¤ì›Œë“œ ê¸°íšìë‹¤.

[ì…ë ¥ í‚¤ì›Œë“œ]
{base_keyword}

Google Trends íŒ¨í„´ê³¼ ë„¤ì´ë²„ ê²€ìƒ‰ ì˜ë„ë¥¼ í•¨ê»˜ ê³ ë ¤í•œë‹¤ê³  ê°€ì •í•˜ê³  ì•„ë˜ë¥¼ ìƒì„±í•´ë¼.

1ë‹¨ê³„: ì´ í‚¤ì›Œë“œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ, ì‹¤ì œ ì‚¬ìš©ìê°€ ê²€ìƒ‰í•  ë²•í•œ ì—°ê´€ í‚¤ì›Œë“œ 50ê°œë¥¼ ë§Œë“ ë‹¤.
- "ì§€ì—­ëª… + êµ¬ì²´ì  ì˜ë„" í˜•íƒœ ìœ„ì£¼ (ì˜ˆ: ì „ì£¼ ë•ì§„ê³µì› ì—°ê½ƒ ì‹œì¦Œ, ì „ì£¼ ë•ì§„ê³µì› ì‚¬ì§„ ëª…ì†Œ)
- ë„ˆë¬´ ë„“ì€ ë‹¨ì–´(ì—¬í–‰, ë§›ì§‘ ê°™ì€ ë‹¨ì–´ ë‹¨ë…)ëŠ” í”¼í•œë‹¤.

2ë‹¨ê³„: ê·¸ ì¤‘ì—ì„œ ë¸”ë¡œê·¸ ìƒìœ„ ë…¸ì¶œ ê°€ëŠ¥ì„±ì´ ë†’ì€ í‚¤ì›Œë“œ 10ê°œë¥¼ ê³ ë¥´ê³ ,
ê°ê°ì— ëŒ€í•´
- keyword : í‚¤ì›Œë“œ
- volume : "ë†’ìŒ" / "ì¤‘ìƒ" / "ì¤‘" ì¤‘ í•˜ë‚˜
- reason : ì™œ ì¢‹ì€ì§€ í•œ ì¤„ë¡œ ì„¤ëª…
ì„ ë§Œë“ ë‹¤.

ì¶œë ¥ì€ ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ì„±í•´ë¼.

{{
  "keywords50": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", ... 50ê°œ],
  "top10": [
    {{"keyword": "í‚¤ì›Œë“œA", "volume": "ë†’ìŒ", "reason": "ì´ìœ "}},
    ...
  ]
}}
"""

    data = call_gpt_json(
        system_msg="ë„ˆëŠ” í•œêµ­ ë„¤ì´ë²„ SEOë¥¼ ì˜ ì•„ëŠ” í‚¤ì›Œë“œ ë¶„ì„ê°€ë‹¤. ë°˜ë“œì‹œ JSONë§Œ ë°˜í™˜í•´ë¼.",
        user_msg=user_prompt,
    )

    # ì—°ê´€ í‚¤ì›Œë“œ 50ê°œ â†’ 5ì—´ ê²©ì
    kw50 = data.get("keywords50", [])[:50]
    while len(kw50) < 50:
        kw50.append("")
    cols = 5
    grid = [kw50[i: i + cols] for i in range(0, 50, cols)]
    kw_table = pd.DataFrame(grid, columns=[f"{i}" for i in range(1, cols + 1)])

    # ìƒìœ„ 10ê°œ
    top10_raw = data.get("top10", [])
    top10_df = pd.DataFrame(top10_raw)
    if not top10_df.empty:
        top10_df = top10_df.rename(
            columns={
                "keyword": "í‚¤ì›Œë“œ",
                "volume": "ê²€ìƒ‰ëŸ‰",
                "reason": "ì´ìœ ",
            }
        )

    return kw_table, top10_df

# -----------------------------
# 2ë‹¨ê³„: ì„ íƒí•œ í‚¤ì›Œë“œë¡œ ë„¤ì´ë²„ ê¸€ ìƒì„±
# -----------------------------
def generate_post(base_keyword: str, selected_keywords: list[str]) -> str:
    """
    ì‚¬ìš©ìê°€ 1~3ê°œ ì§ì ‘ ê³ ë¥¸ í‚¤ì›Œë“œë¡œ ê¸€ ìƒì„±.
    ì²« ë²ˆì§¸ëŠ” ë©”ì¸, ë‘ ë²ˆì§¸ëŠ” ì •ë³´í˜•, ì„¸ ë²ˆì§¸ëŠ” ë¡±í…Œì¼ì´ë¼ê³  ê°„ì£¼í•´ì„œ ì„¤ëª…í•´ ë‹¬ë¼ê³  ì§€ì‹œ.
    """

    if len(selected_keywords) == 0:
        raise ValueError("ìµœì†Œ 1ê°œ ì´ìƒì˜ í‚¤ì›Œë“œë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.")

    # ì•ˆì „í•˜ê²Œ ê¸¸ì´ì— ë”°ë¼ ë©”ì¸/ì •ë³´í˜•/ë¡±í…Œì¼ ë¼ë²¨ë§
    kw_main = selected_keywords[0]
    kw_info = selected_keywords[1] if len(selected_keywords) >= 2 else selected_keywords[0]
    kw_long = selected_keywords[2] if len(selected_keywords) >= 3 else selected_keywords[-1]

    user_prompt = f"""
[ë¸”ë¡œê·¸ ê¸€ ì‘ì„± ìš”ì²­]

- ê¸°ë³¸ ì£¼ì œ í‚¤ì›Œë“œ: {base_keyword}
- ì‚¬ìš©ìê°€ ì§ì ‘ ì„ íƒí•œ í•µì‹¬ í‚¤ì›Œë“œ ëª©ë¡: {selected_keywords}
- ì´ ì¤‘ì—ì„œ
  1) ë©”ì¸ í‚¤ì›Œë“œ: {kw_main}
  2) ì •ë³´í˜• í‚¤ì›Œë“œ: {kw_info}
  3) ë¡±í…Œì¼ í‚¤ì›Œë“œ: {kw_long}
  ë¡œ ê°„ì£¼í•˜ê³  ê¸€ì„ ì‘ì„±í•´ë¼.

ìš”ì²­ì‚¬í•­:
- ë„¤ì´ë²„ ë¸”ë¡œê·¸ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´ ì“¸ ìˆ˜ ìˆëŠ” ê¸€ë¡œ ì‘ì„±í•œë‹¤.
- ë§íˆ¬ëŠ” '~í–ˆì–´ìš”', '~ì…ë‹ˆë‹¤' ìœ„ì£¼ì˜ ë‹´ë°±í•œ 1ì¸ì¹­ ì„¤ëª…í˜•.
- ì œëª©, ë„ì…ë¶€, â‘ ~â‘¤, ë§ˆë¬´ë¦¬, í•´ì‹œíƒœê·¸ê¹Œì§€ ì§€ì¹¨ì„œ êµ¬ì¡°ë¥¼ ì •í™•íˆ ì§€í‚¨ë‹¤.
- ì„ íƒëœ í‚¤ì›Œë“œë“¤ì„ ì œëª©Â·ë³¸ë¬¸Â·í•´ì‹œíƒœê·¸ì— ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ë„£ëŠ”ë‹¤.
- í•´ì‹œíƒœê·¸ëŠ” # ì—†ì´, ì‰¼í‘œë¡œë§Œ êµ¬ë¶„í•´ í•œ ì¤„ì— ì ëŠ”ë‹¤.
- HTML íƒœê·¸ëŠ” ì‚¬ìš©í•˜ì§€ ë§ê³ , ìˆœìˆ˜ í…ìŠ¤íŠ¸/ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œë§Œ ì‘ì„±í•œë‹¤.
"""

    text = call_gpt_text(
        system_msg=GUIDELINE,
        user_msg=user_prompt,
    )
    return text

# -----------------------------
# ì„¸ì…˜ ìƒíƒœ
# -----------------------------
if "kw_table" not in st.session_state:
    st.session_state.kw_table = None
if "top10_df" not in st.session_state:
    st.session_state.top10_df = None
if "base_keyword" not in st.session_state:
    st.session_state.base_keyword = ""
if "selected_keywords" not in st.session_state:
    st.session_state.selected_keywords = []

# -----------------------------
# í™”ë©´ ìƒë‹¨: í‚¤ì›Œë“œ ì…ë ¥ + ë¶„ì„ ë²„íŠ¼
# -----------------------------
base_kw = st.text_input(
    "ë¶„ì„í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ˜Š",
    placeholder="ì˜ˆ: ì „ì£¼ ë•ì§„ê³µì›",
    value=st.session_state.base_keyword,
)

col_btn, _ = st.columns([1, 5])
with col_btn:
    analyze_clicked = st.button("í‚¤ì›Œë“œ ë¶„ì„")

# ë¶„ì„ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ
if analyze_clicked:
    if not base_kw.strip():
        st.warning("í‚¤ì›Œë“œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        try:
            with st.spinner("í‚¤ì›Œë“œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
                kw_table, top10_df = analyze_keywords(base_kw.strip())

            st.session_state.base_keyword = base_kw.strip()
            st.session_state.kw_table = kw_table
            st.session_state.top10_df = top10_df
            st.session_state.selected_keywords = []

        except openai.RateLimitError:
            st.error("OpenAI ìš”ì²­ì´ ë„ˆë¬´ ë§ì´ ëª°ë ¤ì„œ ì œí•œì´ ê±¸ë ¸ì–´ìš”. ê°™ì€ í‚¤ì›Œë“œë¡œ ì—°ì† í´ë¦­ì„ ì¤„ì´ê³ , ì ê¹ ë’¤ì— ë‹¤ì‹œ ì‹œë„í•´ì¤˜ì•¼ í•´ìš”.")
        except Exception as e:
            st.error(f"í‚¤ì›Œë“œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: {e}")

# -----------------------------
# 1ï¸âƒ£ ì—°ê´€ í‚¤ì›Œë“œ 50ê°œ
# -----------------------------
if st.session_state.kw_table is not None:
    st.markdown("### 1ï¸âƒ£ ì—°ê´€ í‚¤ì›Œë“œ 50ê°œ ìƒì„±")
    st.caption("ì •ë ¬ ê¸°ì¤€: ì£¼ì œ ì—°ê´€ì„± + ê²€ìƒ‰ ì˜ë„")
    st.dataframe(
        st.session_state.kw_table,
        use_container_width=True,
        hide_index=True,
    )

# -----------------------------
# 2ï¸âƒ£ ìƒìœ„ ë…¸ì¶œ ê°€ëŠ¥ í‚¤ì›Œë“œ 10ê°œ
# -----------------------------
if st.session_state.top10_df is not None and not st.session_state.top10_df.empty:
    st.markdown("### 2ï¸âƒ£ ìƒìœ„ ë…¸ì¶œ ê°€ëŠ¥ì„±ì´ ë†’ì€ í‚¤ì›Œë“œ 10ê°œ")
    st.dataframe(
        st.session_state.top10_df,
        use_container_width=True,
        hide_index=True,
    )

# -----------------------------
# 3ï¸âƒ£ ê¸€ ìƒì„±ìš© í‚¤ì›Œë“œ ì„ íƒ + ê¸€ ìƒì„±
# -----------------------------
if st.session_state.top10_df is not None and not st.session_state.top10_df.empty:
    st.markdown("### 3ï¸âƒ£ ê¸€ ìƒì„±ìš© í‚¤ì›Œë“œ ì„ íƒ (ìµœëŒ€ 3ê°œ)")

    options = st.session_state.top10_df["í‚¤ì›Œë“œ"].tolist()

    selected = st.multiselect(
        "ê¸€ì— ë°˜ì˜í•  í‚¤ì›Œë“œë¥¼ ê³¨ë¼ì£¼ì„¸ìš” (ìµœëŒ€ 3ê°œ)",
        options=options,
        default=st.session_state.selected_keywords,
    )

    # ìµœëŒ€ 3ê°œ ì œí•œ
    if len(selected) > 3:
        st.warning("ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”. ì•ì˜ 3ê°œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.")
        selected = selected[:3]

    st.session_state.selected_keywords = selected

    if st.button("ì„ íƒí•œ í‚¤ì›Œë“œë¡œ ë„¤ì´ë²„ ë¸”ë¡œê·¸ ê¸€ ìë™ ìƒì„±"):
        if len(selected) == 0:
            st.warning("ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì•¼ ê¸€ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.")
        else:
            try:
                with st.spinner("ë„¤ì´ë²„ ë¸”ë¡œê·¸ìš© ê¸€ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤..."):
                    post = generate_post(
                        st.session_state.base_keyword,
                        selected,
                    )
                st.markdown("## âœï¸ ì§€ì¹¨ì„œ ê¸°ë°˜ ì™„ì„± ê¸€")
                st.markdown(post)
            except openai.RateLimitError:
                st.error("OpenAI ìš”ì²­ ì œí•œ ë•Œë¬¸ì— ê¸€ ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì¡°ê¸ˆ ë’¤ì— ë‹¤ì‹œ ëˆŒëŸ¬ì¤˜ì•¼ í•´ìš”.")
            except Exception as e:
                st.error(f"ê¸€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: {e}")
else:
    st.caption("í‚¤ì›Œë“œ ë¶„ì„ì„ ë¨¼ì € ì‹¤í–‰í•˜ë©´ 1Â·2ë²ˆ í‘œì™€ 3ë²ˆ ì„ íƒ ì˜ì—­ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.")
