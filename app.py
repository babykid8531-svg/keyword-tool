import streamlit as st
from pytrends.request import TrendReq
import pandas as pd
import math
import time

# -----------------------------
# ê¸°ë³¸ ì„¤ì •
# -----------------------------
st.set_page_config(page_title="í‚¤ì›Œë“œ ì¶”ì²œ ë° ë¶„ì„ë°›ê¸°")
st.title("í‚¤ì›Œë“œ ì¶”ì²œ ë° ë¶„ì„ë°›ê¸°")

keyword = st.text_input(
    "ë¶„ì„í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ˜Š",
    placeholder="ì˜ˆ: ì „ì£¼, ì „ì£¼ì—¬í–‰ ê°€ë³¼ë§Œí•œê³³"
)

# -----------------------------
# ìœ í‹¸ í•¨ìˆ˜ë“¤
# -----------------------------
def make_grid(items, cols=5):
    rows = math.ceil(len(items) / cols)
    grid = [items[i*cols:(i+1)*cols] for i in range(rows)]
    return pd.DataFrame(grid).fillna("")

def search_level(idx):
    if idx < 2:
        return "ë†’ìŒ"
    elif idx < 5:
        return "ì¤‘ìƒ"
    else:
        return "ì¤‘"

def reason_for_keyword(kw):
    if any(x in kw for x in ["ì‹œì¦Œ", "ê°œí™”", "ì‹œê¸°"]):
        return "ì‹œì¦Œì„± ì •ë³´ ê²€ìƒ‰ ìˆ˜ìš” ì§‘ì¤‘"
    if any(x in kw for x in ["í›„ê¸°", "ë¦¬ë·°", "ê¸°ë¡"]):
        return "í›„ê¸°í˜• ì½˜í…ì¸  ì„ í˜¸"
    if any(x in kw for x in ["ëª…ì†Œ", "ì‚¬ì§„", "ë·°"]):
        return "ì‚¬ì§„Â·ë·° ëª©ì  ê²€ìƒ‰"
    if any(x in kw for x in ["ì½”ìŠ¤", "ì‚°ì±…", "ë°ì´íŠ¸"]):
        return "ë™ì„ Â·ì½”ìŠ¤ íƒìƒ‰í˜• ê²€ìƒ‰"
    if any(x in kw for x in ["ì—¬í–‰", "ê°€ë³¼ë§Œí•œê³³"]):
        return "ì—¬í–‰ ëŒ€í‘œ í‚¤ì›Œë“œ"
    return "ì§€ì—­ + ì£¼ì œ ê²°í•© í‚¤ì›Œë“œ"

# êµ¬ê¸€ì´ ë§‰í˜€ë„ ìµœì†Œí•œ ì´ ì •ë„ëŠ” ë½‘ì•„ì£¼ê¸°
def generate_fallback(base_kw):
    base = base_kw.strip()
    suffixes = [
        "ê°€ë³¼ë§Œí•œê³³", "ì—¬í–‰", "ê´€ê´‘ì§€", "ë§›ì§‘", "ë°ì´íŠ¸",
        "ì½”ìŠ¤", "ì¶”ì²œ", "í›„ê¸°", "ì‚¬ì§„ ëª…ì†Œ", "ì‚°ì±…"
    ]
    return [f"{base} {s}" for s in suffixes]

# -----------------------------
# ë¶„ì„ í•¨ìˆ˜ (429 ì—ëŸ¬ ë°©ì–´ í¬í•¨)
# -----------------------------
@st.cache_data(show_spinner=False)
def analyze(keyword: str):
    keywords = []

    try:
        pytrends = TrendReq(hl="ko", tz=540)
        pytrends.build_payload([keyword], timeframe="today 12-m", geo="KR")

        # ìš”ì²­ ê°„ê²© ì¡°ê¸ˆ ë„‰ë„‰í•˜ê²Œ
        time.sleep(1)

        related = pytrends.related_queries()
        rq = related.get(keyword)

        if rq:
            if rq.get("top") is not None:
                keywords.extend(rq["top"]["query"].tolist())
            if rq.get("rising") is not None:
                keywords.extend(rq["rising"]["query"].tolist())
    except Exception:
        # êµ¬ê¸€ì—ì„œ ë§‰íˆë©´ ì¡°ìš©íˆ íŒ¨ìŠ¤í•˜ê³  fallbackìœ¼ë¡œ ê°
        pass

    if not keywords:
        keywords = generate_fallback(keyword)

    # ì¤‘ë³µ ì œê±°í•˜ê³  ìµœëŒ€ 50ê°œ
    keywords = list(dict.fromkeys(keywords))[:50]

    # ìƒìœ„ 10ê°œì— ê²€ìƒ‰ëŸ‰/ì´ìœ  ë¶™ì´ê¸°
    top_rows = []
    for i, kw in enumerate(keywords[:10]):
        top_rows.append({
            "í‚¤ì›Œë“œ": kw,
            "ê²€ìƒ‰ëŸ‰": search_level(i),
            "ì´ìœ ": reason_for_keyword(kw)
        })

    top10_df = pd.DataFrame(top_rows)
    return keywords, top10_df

# -----------------------------
# ê¸€ ë¼ˆëŒ€ ìƒì„± í•¨ìˆ˜ (ë„¤ì´ë²„ ì§€ì¹¨ì„œ ë°˜ì˜)
# -----------------------------
def generate_article(main_kw: str, sub_kws: list[str]) -> str:
    sub1, sub2 = sub_kws[0], sub_kws[1]

    text = f"""
0ï¸âƒ£ ì´ ì§€ì¹¨ì„œ í•œ ë¬¸ì¥ ìš”ì•½  
ë„¤ì´ë²„ëŠ” â€˜ì •ë³´ êµ¬ì¡°ê°€ í”ë“¤ë¦¬ì§€ ì•ŠëŠ” ê¸€â€™ì„ ìœ„ë¡œ ì˜¬ë¦°ë‹¤.  
ê·¸ë˜ì„œ ì£¼ì œê°€ ë°”ë€Œì–´ë„ êµ¬ì¡°ëŠ” ì ˆëŒ€ ë°”ê¾¸ì§€ ì•ŠëŠ”ë‹¤.

---

## 1ï¸âƒ£ ê¸€ ì „ì²´ ê³ ì • êµ¬ì¡° (ëª¨ë“  ê¸€ ê³µí†µ)

ì•„ë˜ ìˆœì„œë¥¼ í•­ìƒ ìœ ì§€í•´ì„œ ì‘ì„±í•œë‹¤.

1. ì œëª©  
2. ë„ì…ë¶€(ì¸ì‚¬ + ìš”ì•½)  
3. ì´ê³³ì€ ì–´ë–¤ ê³³ì¸ê°€  
4. ìš´ì˜ì‹œê°„Â·ì´ìš© ì¡°ê±´  
5. ë‚´ë¶€ êµ¬ì¡°Â·ê´€ëŒ ë™ì„   
6. ì£¼ì°¨Â·ëŒ€ì¤‘êµí†µ ì •ë³´  
7. ì´ëŸ° ì‚¬ëŒì—ê²Œ ë§ëŠ”ë‹¤  
8. ë§ˆë¬´ë¦¬  
9. í•´ì‹œíƒœê·¸  

---

## 2ï¸âƒ£ ì œëª© ì‘ì„± (ë„¤ì´ë²„ SEO í•µì‹¬)

**ì œëª© ì˜ˆì‹œ**  
> {main_kw} ìš´ì˜ì‹œê°„Â·ì£¼ì°¨Â·ìœ„ì¹˜ ì´ì •ë¦¬ ({sub1})

- ì œëª©ì€ ê²€ìƒ‰ì–´ ë¬¸ì¥ ê·¸ëŒ€ë¡œ ì‚¬ìš©  
- ê°ì„± ë‹¨ì–´(í›„ê¸°, ê°•ì¶”, íë§ ë“±)ëŠ” ë„£ì§€ ì•ŠëŠ”ë‹¤  

---

## 3ï¸âƒ£ SEO í‚¤ì›Œë“œ ë°°ì¹˜

- ë©”ì¸ í‚¤ì›Œë“œ: **{main_kw}**  
- ì„œë¸Œ í‚¤ì›Œë“œ: **{sub1}**, **{sub2}**

ë°°ì¹˜ ê·œì¹™:

- ì œëª©: ë©”ì¸ í‚¤ì›Œë“œ + ì„œë¸Œ í‚¤ì›Œë“œ 1ê°œ  
- ë„ì…ë¶€ 1~2ë¬¸ì¥: ë©”ì¸ í‚¤ì›Œë“œ 1íšŒ  
- ê° ì†Œì œëª©: ë©”ì¸ ë˜ëŠ” ì„œë¸Œ í‚¤ì›Œë“œ 1ê°œ í¬í•¨  
- ë³¸ë¬¸ ì¤‘ê°„: ì„œë¸Œ í‚¤ì›Œë“œ ìì—°ìŠ¤ëŸ½ê²Œ ë¶„ì‚°  
- ë§ˆë¬´ë¦¬ ë¬¸ë‹¨: ë©”ì¸ í‚¤ì›Œë“œ 1íšŒ  
- í•´ì‹œíƒœê·¸: ë©”ì¸ í‚¤ì›Œë“œ + ì§€ì—­ í‚¤ì›Œë“œ  

ê°™ì€ ë§ì„ ì–µì§€ë¡œ ë°˜ë³µí•˜ì§€ ë§ê³ , ë™ì˜ì–´ë¥¼ ì„ëŠ”ë‹¤.

---

## 4ï¸âƒ£ ì‚¬ì§„ ë°°ì¹˜ ê·œì¹™

- ì‚¬ì§„ì€ **í•­ìƒ ì†Œì œëª© ë°”ë¡œ ì•„ë˜**ì—ë§Œ ë°°ì¹˜  
- ë¬¸ë‹¨ ì¤‘ê°„ì—ëŠ” ë„£ì§€ ì•ŠëŠ”ë‹¤  

ì¶”ì²œ êµ¬ì„±:

- ì†Œì œëª© 1ê°œë‹¹ 1~2ì¥  
- ì „ì²´ ê¸€ ê¸°ì¤€ ìµœì†Œ 6ì¥  

ì¢…ë¥˜ ì˜ˆì‹œ:

- ì™¸ê´€ ì‚¬ì§„  
- ë‚´ë¶€ ì „ê²½  
- ì•ˆë‚´íŒÂ·ì„¤ëª…íŒ  
- ì£¼ì°¨ì¥ ë˜ëŠ” ì§€ë„  
- ë¶„ìœ„ê¸° ì»·  

---

## 5ï¸âƒ£ ë„ì…ë¶€ ì˜ˆì‹œ (4~5ì¤„)

> ì•ˆë…•í•˜ì„¸ìš”. {main_kw} ì •ë³´ë¥¼ ì •ë¦¬í•´ì„œ ê³µìœ í•©ë‹ˆë‹¤.  
> ì´ ê¸€ì—ì„œëŠ” ìš´ì˜ì‹œê°„, ì£¼ì°¨, ìœ„ì¹˜, ê´€ëŒ ë™ì„ ì„ í•œ ë²ˆì— ë³¼ ìˆ˜ ìˆë„ë¡ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.  
> ì²˜ìŒ ë°©ë¬¸í•˜ì‹œëŠ” ë¶„ë“¤ë„ {sub2} ì—†ì´ ì¤€ë¹„í•  ìˆ˜ ìˆë„ë¡ ì •ë³´ë¥¼ êµ¬ì¡°í™”í–ˆìŠµë‹ˆë‹¤.  
> ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì°¨ê·¼ì°¨ê·¼ ë³´ì‹œë©´ í—·ê°ˆë¦¬ì§€ ì•Šì„ ê±°ì˜ˆìš”.

ë„ì…ë¶€ì—ëŠ” **í›„ê¸°Â·ê°ì •Â·í‰ê°€ë¥¼ ë„£ì§€ ì•ŠëŠ”ë‹¤.**  
ì˜¤ë¡œì§€ â€œë¬´ìŠ¨ ì •ë³´ë¥¼ ì£¼ëŠ” ê¸€ì¸ì§€â€ë§Œ ëª…í™•íˆ ì¨ì¤€ë‹¤.

---

## 6ï¸âƒ£ 1ë²ˆ íŒŒíŠ¸ â€“ ì´ê³³ì€ ì–´ë–¤ ê³³ì¸ê°€

ì†Œì œëª© ì˜ˆì‹œ  
> {main_kw}ëŠ” ì–´ë–¤ ê³³ì¸ê°€

ë‚´ìš© êµ¬ì„± ì˜ˆ:

- ê³¼ê±° ìš©ë„ ë˜ëŠ” ë°°ê²½  
- ì–´ë–¤ ê³„ê¸°ë¡œ ì§€ê¸ˆ ëª¨ìŠµì´ ë˜ì—ˆëŠ”ì§€  
- í˜„ì¬ëŠ” ì–´ë–¤ ì—­í• ì„ í•˜ëŠ” ê³µê°„ì¸ì§€  

ì—°ë„Â·ìˆ«ìÂ·ì‚¬ì‹¤ì„ ìš°ì„ í•˜ê³ ,  
ê°œì¸ ê°ì •ì€ í•œ ë¬¸ë‹¨ì— í•œ ë¬¸ì¥ë§Œ ë„£ëŠ”ë‹¤.

---

## 7ï¸âƒ£ 2ë²ˆ íŒŒíŠ¸ â€“ ìš´ì˜ì‹œê°„Â·ì´ìš© ì¡°ê±´

ë°˜ë“œì‹œ ì ëŠ” í•­ëª©:

- ìš´ì˜ ìš”ì¼  
- ìš´ì˜ ì‹œê°„  
- ì…ì¥/ë§ˆê° ì‹œê°„  
- íœ´ê´€ì¼  
- ì‹œì„¤ë³„ ì°¨ì´(ìˆìœ¼ë©´)  

ëª¨ë“  ë¬¸ì¥ì€ ë‹¨ì •í˜•ìœ¼ë¡œ ì‘ì„±í•œë‹¤.  
ë§ˆì§€ë§‰ì— â€œì£¼ì˜ì‚¬í•­/íŒâ€ ë¬¸ì¥ 1ì¤„ì„ ë„£ì–´ì¤€ë‹¤.

---

## 8ï¸âƒ£ 3ë²ˆ íŒŒíŠ¸ â€“ ë‚´ë¶€ êµ¬ì¡°Â·ê´€ëŒ ë™ì„ 

ì²˜ìŒ ê°€ëŠ” ì‚¬ëŒ ê¸°ì¤€ìœ¼ë¡œ ì“´ë‹¤.

ì˜ˆì‹œ:

1. ì–´ë”” ì…êµ¬ì—ì„œ ì‹œì‘í•˜ëŠ”ì§€  
2. ì–´ë–¤ ìˆœì„œë¡œ ë‘˜ëŸ¬ë³´ëŠ”ì§€  
3. ì „ì²´ ì†Œìš” ì‹œê°„ì€ ì–´ëŠ ì •ë„ì¸ì§€  

ë§ˆì§€ë§‰ì— ì‹¤ì „ íŒ:

> ì‚¬ì§„ ì°ê¸° ì¢‹ì€ ì‹œê°„ëŒ€,  
> ë¶ë¹„ì§€ ì•ŠëŠ” ì‹œê°„,  
> ë™ì„ ì„ ì–´ëŠ ë°©í–¥ìœ¼ë¡œ ë„ëŠ” ê²Œ í¸í•œì§€ ë“±ì„ í•œ ì¤„ë¡œ ì ì–´ì¤€ë‹¤.

---

## 9ï¸âƒ£ 4ë²ˆ íŒŒíŠ¸ â€“ ì£¼ì°¨Â·ëŒ€ì¤‘êµí†µ ì •ë³´

ê°ì • í‘œí˜„ ì—†ì´, ì •ë³´ë§Œ ì •ë¦¬í•œë‹¤.

- ì£¼ì°¨: ë¬´ë£Œ/ìœ ë£Œ, ëŒ€ìˆ˜, ì£¼ì†Œ, ë„ë³´ ê±°ë¦¬  
- ëŒ€ì¤‘êµí†µ: ì£¼ìš” ì¶œë°œì§€ ê¸°ì¤€ ë…¸ì„ , í•˜ì°¨ í›„ ë„ë³´ ì‹œê°„  

ë§ˆì§€ë§‰ì— ì ‘ê·¼ì„±ì— ëŒ€í•œ í•œ ì¤„ ì •ë¦¬:

> â€œì°¨ê°€ ìˆëŠ” ì‚¬ëŒì´ í›¨ì”¬ í¸í•˜ë‹¤â€  
> â€œëŒ€ì¤‘êµí†µë§Œìœ¼ë¡œë„ ë¬´ë¦¬ ì—†ì´ ë°©ë¬¸ ê°€ëŠ¥í•˜ë‹¤â€ ë“±

---

## ğŸ”Ÿ 5ë²ˆ íŒŒíŠ¸ â€“ ì´ëŸ° ì‚¬ëŒì—ê²Œ ë§ëŠ”ë‹¤

ì¶”ì²œì´ ì•„ë‹ˆë¼ **ë¶„ë¥˜**ë¡œ ì“´ë‹¤.

- ì´ëŸ° ì‚¬ëŒì—ê²Œ ë§ìŒ: 3~4ê°€ì§€ ìœ í˜•  
- ë§ì§€ ì•Šì„ ìˆ˜ ìˆëŠ” ê²½ìš°: 1ì¤„ë§Œ ì–¸ê¸‰  

â€œë¬´ì¡°ê±´ ì¶”ì²œâ€ â€œê°•ë ¥ ì¶”ì²œâ€ ê°™ì€ í‘œí˜„ì€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

---

## 1ï¸âƒ£1ï¸âƒ£ ë§ˆë¬´ë¦¬ ë¬¸ë‹¨

3ë¬¸ì¥ êµ¬ì¡°ë¡œ ì‘ì„±:

1. ì˜¤ëŠ˜ ì •ë¦¬í•œ ë‚´ìš© í•œ ì¤„ ìš”ì•½  
2. í•µì‹¬ ì¥ì  í•œ ì¤„  
3. ë¶€ë“œëŸ¬ìš´ ë°©ë¬¸ ìœ ë„ ë¬¸ì¥(ì§ˆë¬¸í˜• 1ê°œê¹Œì§€ í—ˆìš©)

---

## 1ï¸âƒ£2ï¸âƒ£ í•´ì‹œíƒœê·¸ ì‘ì„±

ê°œìˆ˜: 7~10ê°œ

êµ¬ì„± ì˜ˆì‹œ:

- #{main_kw}  
- #ì§€ì—­ëª… (ì˜ˆ: #ì „ì£¼)  
- #ì§€ì—­ëª…ê°€ë³¼ë§Œí•œê³³  
- #{sub1}  
- #{sub2}  
- #ìš´ì˜ì‹œê°„ #ì£¼ì°¨ì •ë³´ #ìœ„ì¹˜ì •ë¦¬  

ê°ì„± í•´ì‹œíƒœê·¸(íë§, ê°ì„±ì¹´í˜ ë“±)ëŠ” ë„£ì§€ ì•ŠëŠ”ë‹¤.

---

ğŸ”’ **í•µì‹¬ ë¬¸ì¥**  
> ì£¼ì œëŠ” ë‹¬ë¼ë„, êµ¬ì¡°ëŠ” í•˜ë‚˜ì—¬ì•¼ ê²€ìƒ‰ì´ í”ë“¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤.
"""
    return text

# -----------------------------
# ë©”ì¸ íë¦„
# -----------------------------
if st.button("í‚¤ì›Œë“œ ì¶”ì²œ ë° ë¶„ì„í•˜ê¸°"):
    if not keyword:
        st.warning("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        with st.spinner("í‚¤ì›Œë“œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
            all_keywords, top10_df = analyze(keyword)

        # 1) ì—°ê´€ í‚¤ì›Œë“œ 50ê°œ
        st.markdown("## 1ï¸âƒ£ ì—°ê´€ í‚¤ì›Œë“œ 50ê°œ")
        st.caption("ì •ë ¬ ê¸°ì¤€: ì£¼ì œ ì—°ê´€ì„± + ê²€ìƒ‰ ë¹ˆë„")
        st.dataframe(make_grid(all_keywords))

        # 2) ìƒìœ„ ë…¸ì¶œ ê°€ëŠ¥ í‚¤ì›Œë“œ 10ê°œ
        st.markdown("## 2ï¸âƒ£ ìƒìœ„ ë…¸ì¶œ ê°€ëŠ¥ì„± ë†’ì€ í‚¤ì›Œë“œ 10ê°œ")
        st.dataframe(top10_df)

        # 3) í‚¤ì›Œë“œ 3ê°œ ì„ íƒ
        st.markdown("## 3ï¸âƒ£ ê¸€ ìƒì„±ìš© í‚¤ì›Œë“œ ì„ íƒ (ìµœëŒ€ 3ê°œ)")
        selected_keywords = []
        for kw in top10_df["í‚¤ì›Œë“œ"]:
            if st.checkbox(kw, key=f"chk_{kw}"):
                selected_keywords.append(kw)

        if selected_keywords:
            st.write("í˜„ì¬ ì„ íƒí•œ í‚¤ì›Œë“œ:", ", ".join(selected_keywords))

        # 4) ì„ íƒí•œ í‚¤ì›Œë“œë¡œ ê¸€ ë¼ˆëŒ€ ë§Œë“¤ê¸°
        if st.button("âœ… ì„ íƒí•œ í‚¤ì›Œë“œë¡œ ê¸€ ë¼ˆëŒ€ ë§Œë“¤ê¸°"):
            if len(selected_keywords) != 3:
                st.error("í‚¤ì›Œë“œë¥¼ ì •í™•íˆ 3ê°œ ì„ íƒí•´ ì£¼ì„¸ìš”.")
            else:
                main_kw = selected_keywords[0]
                sub_kws = selected_keywords[1:]
                article = generate_article(main_kw, sub_kws)
                st.markdown("---")
                st.markdown(f"### âœ ìƒì„±ëœ ê¸€ ë¼ˆëŒ€ (ë©”ì¸: {main_kw})")
                st.markdown(article)
